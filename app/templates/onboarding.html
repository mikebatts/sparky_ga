<!-- onboarding.html -->
<!DOCTYPE html>
<html class="ob-html">
<head>
    <title>Onboarding | Sparky</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

</head>
<body class="ob-body">

    <div class="onboarding-nav">
        <button onclick="goToPreviousStep()" class="onboard-nav-button" id="onboard-nav-button">
            <i data-feather="chevron-left"></i>
        </button>
        <button onclick="closeOnboarding()" class="onboard-nav-button" id="closeButton">
            <i data-feather="x"></i>
        </button>
    </div>

    <!-- Onboarding Modal -->
    <div id="onboardingModal" class="onboarding-modal">

        <!-- Navigation Bar -->
        <!-- <div class="onboarding-nav">
            <button onclick="goToPreviousStep()" class="onboard-nav-button" id="onboard-nav-button">
                <i data-feather="chevron-left"></i>
            </button>
            <button onclick="closeOnboarding()" class="onboard-nav-button" id="closeButton">
                <i data-feather="x"></i>
            </button>
        </div> -->


         <!-- Welcome Step (Taken from old welcome.html) -->
        <div class="modal-step" id="step1">
            <div class="container-onboarding">
                <div class="onboarding-body">
                    <h1>Welcome to Sparky.</h1>
                    <p>Connect your analytics and set your goals. We'll analyze your data to provide insights and strategies tailored towards you care about.</p>
                </div>
                <div class="onboarding-CTA-container">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                            <div class="alert {{ category }}">{{ message }}</div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}             
                    <button onclick="nextStep(2)">Sign up with Google</button>
                    <p class="disclaimer">We currently support Google Analytics 4, <br>with more integrations coming soon.</p>
                </div>
            </div>
        </div>

        <!-- Business Info Step (Taken from old business_info.html) -->
        <div class="modal-step" id="step2" style="display:none;">
            <div class="container-onboarding">
                <div class="onboarding-biz-body">
                  
                    
                    <form id="business-info-form" enctype="multipart/form-data">
                        <div class="biz-info-wrapper"></div>
                            <h1>Your business.</h1>
                            <p class="biz-body-copy">Tell us about your business so we can tailor Sparky's insights to your needs.</p>
                            <!-- Avatar Upload -->
                            <div class="form-group avatar-upload-container">
                                <p>Photo</p>
                                <div class="avatar-upload-wrapper">
                                    <div class="avatar-preview" id="avatar-placeholder"></div>
                                    <button type="button" id="avatar-button" onclick="handleAvatarClick()">Upload</button>
                                    <input type="file" id="avatar-upload" name="avatar" class="hidden" onchange="previewAvatar(event)">
                                </div>
                                
                            </div>

                            <!-- Business Name Input -->
                            <div class="form-group">
                                <p for="business-name">Name</p>
                                <input type="text" id="business-name" name="business_name" placeholder="Enter your business name">
                            </div>

                            <!-- Business Description Input -->
                            <div class="form-group">
                                <p for="business-description">Description</p>
                                <textarea id="business-description" name="business_description" placeholder="Describe your business"></textarea>
                            </div>
                        </div>

                        <div class="onboarding-CTA-container">
                            <button type="button" onclick="saveBusinessInfo()">Next</button>
                        </div>
                    </form>
                </div>
            </div>
        
        

        <!-- Goals Step -->
        <div class="modal-step" id="step3" style="display:none;">
            <div class="container-onboarding">
                <div class="onboarding-biz-body">
                    <div class="biz-info-wrapper">
                        <h1>Set your goals.</h1>
                        <p>Prioritize your business goals, ranking from most to least important. This lets Sparky deliver more relevant and customized reports.</p>
                        <ul id="goalsList" class="draggable-list">
                            <li class="draggable-item" draggable="true"><span class="item-number">1</span> More visitors <i class="icon-right"></i></li>
                            <li class="draggable-item" draggable="true"><span class="item-number">2</span> Higher sales <i class="icon-right"></i></li>
                            <li class="draggable-item" draggable="true"><span class="item-number">3</span> Increase engagement <i class="icon-right"></i></li>
                            <li class="draggable-item" draggable="true"><span class="item-number">4</span> Improve conversion rate <i class="icon-right"></i></li>
                            <li class="draggable-item" draggable="true"><span class="item-number">5</span> Improve SEO rankings <i class="icon-right"></i></li>
                        </ul>
                    </div>
                    <div class="onboarding-CTA-container">
                        <button onclick="nextStep(4)">Next</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preferences Step -->
        <div class="modal-step" id="step4" style="display:none;">
            <div class="container-onboarding">
                <div class="onboarding-biz-body">
                    <div class="biz-info-wrapper">
                        <h1>Set your preferences.</h1>
                        <p>Rank the metrics you care about, we’ll keep you informed about data points that matter to you the most.</p>
                        <ul id="preferencesList" class="draggable-list">
                            <li class="draggable-item" draggable="true"><span class="item-number">1</span> Traffic sources <i class="icon-right"></i></li>
                            <li class="draggable-item" draggable="true"><span class="item-number">2</span> Top selling products <i class="icon-right"></i></li>
                            <li class="draggable-item" draggable="true"><span class="item-number">3</span> Customer value <i class="icon-right"></i></li>
                            <li class="draggable-item" draggable="true"><span class="item-number">4</span> Card abandonment <i class="icon-right"></i></li>
                            <li class="draggable-item" draggable="true"><span class="item-number">5</span> Bounce rate <i class="icon-right"></i></li>
                        </ul>
                    </div>
                    <div class="onboarding-CTA-container">
                        <button onclick="saveGoalsAndPreferences()">Next</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirmation Step -->
        <div class="modal-step" id="step5" style="display:none;">
            <div class="container-onboarding">
                <div class="onboarding-biz-body">
                    <div class="biz-info-wrapper">
                        <h1>You’re ready for your first report!</h1>
                        <p>You’ve successfully set up your profile, goals, and preferences. You may update these settings any time in the app.</p>
                    </div>
                    <div class="onboarding-CTA-container">
                        <a href="{{ url_for('main.select_property') }}"><button onclick="completeOnboarding()">Get Started</button></a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            new Sortable(document.getElementById('goalsList'), {
                animation: 150,
                ghostClass: "sortable-ghost",
                onEnd: function(evt) {
                    updateNumbers(evt.to);
                }
            });

            new Sortable(document.getElementById('preferencesList'), {
                animation: 150,
                ghostClass: "sortable-ghost",
                onEnd: function(evt) {
                    updateNumbers(evt.to);
                }
            });

            function updateNumbers(list) {
                Array.from(list.children).forEach((item, index) => {
                    item.querySelector('.item-number').textContent = index + 1;
                });
            }


            });
        

            let currentStep = 1;

            function goToPreviousStep() {
                if (currentStep > 1) {
                    currentStep--;
                    showStep(currentStep);
                }
            }

            function showStep(stepNumber) {
                console.log('showStep called with step number: ' + stepNumber);
                // Hide all steps
                document.querySelectorAll('.modal-step').forEach(step => {
                    step.style.display = 'none';
                });
                // Hide the back button if on the first step
                var backButton = document.getElementById('onboard-nav-button');
                if (stepNumber === 1) {
                    console.log('Hiding back button because stepNumber is 1');
                    backButton.style.display = 'none';
                } else {
                    console.log('Showing back button because stepNumber is greater than 1');
                    backButton.style.display = 'block';
                }
                // Show the current step
                var currentStepElement = document.getElementById('step' + stepNumber);
                if (currentStepElement) {
                    currentStepElement.style.display = 'block';
                } else {
                    console.error('No element found for step', stepNumber);
                }
            }



            function closeOnboarding() {
                fetch('/abandon_onboarding')
                .then(() => {
                    window.location.href = "{{ url_for('main.index') }}";
                });
            }




            // function nextStep(stepNumber) {
            //     console.log("Moving to next step:", stepNumber);
            //     // Hide all steps
            //     document.querySelectorAll('.modal-step').forEach(step => step.style.display = 'none');
            //     // Show next step
            //     var nextStepElement = document.getElementById('step' + stepNumber);
            //     console.log("Next step element:", nextStepElement);
            //     if (nextStepElement) {
            //         nextStepElement.style.display = 'block';
            //     } else {
            //         console.error('No element found for step', stepNumber);
            //     }
            // }

            function nextStep(stepNumber) {
                console.log("Moving to next step:", stepNumber);
                currentStep = stepNumber; // Update the current step
                // Hide all steps
                document.querySelectorAll('.modal-step').forEach(step => step.style.display = 'none');
                // Show next step
                var stepElement = document.getElementById('step' + stepNumber);
                showStep(currentStep); // Update the display based on the current step
            }

            function previousStep(stepNumber) {
                console.log("Returning to previous step:", stepNumber);
                currentStep = stepNumber; // Update the current step
                // Hide all steps
                document.querySelectorAll('.modal-step').forEach(step => step.style.display = 'none');
                // Show previous step
                var prevStepElement = document.getElementById('step' + currentStep);
                if (prevStepElement) {
                    prevStepElement.style.display = 'block';
                } else {
                    console.error('No element found for step', currentStep);
                }
                showStep(currentStep); // Update the display based on the current step
            }


            //Session storage
            let onboardingData = {};

            function uploadAvatar() {
                const avatarFile = document.getElementById('avatar-upload').files[0];
                console.log("uploadAvatar called with file:", avatarFile); // Debugging

                if (avatarFile) {
                    let formData = new FormData();
                    formData.append('avatar', avatarFile);
                    console.log("FormData prepared", formData); // Debugging

                    fetch('/upload_avatar', {
                        method: 'POST',
                        body: formData
                    }).then(response => {
                        console.log("Upload response received", response); // Debugging
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            console.log('Avatar uploaded successfully', data); // Debugging
                            onboardingData.avatar = data.avatarURL; // Store the avatar URL
                        } else {
                            console.error('Error uploading avatar:', data.message);
                        }
                    }).catch(error => {
                        console.error('Error in uploadAvatar:', error);
                    });
                } else {
                    console.log("No file to upload"); // Debugging
                }
            }

            function previewAvatar(event) {
                const reader = new FileReader();
                const file = event.target.files[0];
                const avatarPlaceholder = document.getElementById('avatar-placeholder');
                const avatarButton = document.getElementById('avatar-button');

                if (file) {
                    reader.readAsDataURL(file);
                    reader.onloadend = function() {
                        avatarPlaceholder.style.backgroundImage = `url(${reader.result})`;
                        avatarButton.textContent = 'Remove'; // Change button text to 'Remove'
                        uploadAvatar(); // Call uploadAvatar here to handle file upload
                    };
                }
            }





            function storeBusinessInfo() {
                onboardingData.businessName = document.getElementById('business-name').value;
                onboardingData.businessDescription = document.getElementById('business-description').value;

                var avatarFile = document.getElementById('avatar-upload').files[0];
                if (avatarFile) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        onboardingData.avatarBase64 = e.target.result;
                    };
                    reader.readAsDataURL(avatarFile);
                }
            }

            function storeGoalsAndPreferences() {
                onboardingData.goals = Array.from(document.getElementById('goalsList').children).map(li => li.textContent);
                onboardingData.preferences = Array.from(document.getElementById('preferencesList').children).map(li => li.textContent);
            }
                               



            function saveBusinessInfo() {
                onboardingData.businessName = document.getElementById('business-name').value;
                onboardingData.businessDescription = document.getElementById('business-description').value;
                
                // Add code here to send business info to the server
                fetch('/save_business_info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        businessName: onboardingData.businessName,
                        businessDescription: onboardingData.businessDescription
                    })
                }).then(response => response.json())
                .then(data => {
                    console.log('Business info saved:', data);
                }).catch(error => {
                    console.error('Error saving business info:', error);
                });

                currentStep = 3; // Set this to the number of the next step
                showStep(currentStep);
            }



            function saveGoalsAndPreferences() {
                onboardingData.goals = Array.from(document.getElementById('goalsList').children).map(li => li.textContent.trim());
                onboardingData.preferences = Array.from(document.getElementById('preferencesList').children).map(li => li.textContent.trim());
                currentStep = 5; // Set this to the number of the next step
                showStep(currentStep);
            }



            function handleAvatarClick() {
                const avatarUpload = document.getElementById('avatar-upload');
                if (avatarUpload.value) {
                    removeAvatar();
                } else {
                    avatarUpload.click();
                }
            }

            



           

            function removeAvatar() {
                const avatarPlaceholder = document.getElementById('avatar-placeholder');
                const avatarButton = document.getElementById('avatar-button');

                document.getElementById('avatar-upload').value = '';
                avatarPlaceholder.style.backgroundImage = '';
                avatarButton.textContent = 'Upload'; // Change button text back to 'Upload'
            }


            function completeOnboarding() {
                // Check if avatar is being uploaded, and wait for it to complete
                if (onboardingData.avatarPromise) {
                    onboardingData.avatarPromise.then(() => {
                        sendOnboardingData();
                    }).catch(error => {
                        console.error('Error during avatar upload:', error);
                    });
                } else {
                    sendOnboardingData();
                }
            }

            function sendOnboardingData() {
                // Store business info and goals & preferences before sending data
                storeBusinessInfo();
                storeGoalsAndPreferences();

                console.log('Sending onboarding data:', onboardingData);

                // Now send the complete data
                fetch('/complete_onboarding', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(onboardingData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.location.href = "{{ url_for('main.index') }}";
                    } else {
                        console.error('Error:', data.message);
                    }
                }).catch(error => {
                    console.error('Error during data submission:', error);
                });
            }





            // This code should be run in the browser's console
            function debugShowStep(stepNumber) {
                // Hide all steps
                document.querySelectorAll('.modal-step').forEach(step => {
                    step.style.display = 'none';
                });
                // Hide the back button if on the first step
                var backButton = document.getElementById('onboard-nav-button');
                if (stepNumber === 1) {
                    backButton.style.display = 'none';
                } else {
                    backButton.style.display = 'block'; // Show back button if not on the first step
                }
                // Show the current step
                var currentStepElement = document.getElementById('step' + stepNumber);
                if (currentStepElement) {
                    currentStepElement.style.display = 'block';
                } else {
                    console.error('No element found for step', stepNumber);
                }
            }

            // Call this function with different step numbers to see if it correctly shows/hides the back button
            debugShowStep(1); // Should hide the back button
            debugShowStep(2); // Should show the back button
            debugShowStep(3); // Should show the back button



            // Set the initial step
            showStep(currentStep); // This will hide the back button on the first step

            // Replace feather icons
            feather.replace();
    </script>
</body>
</html>