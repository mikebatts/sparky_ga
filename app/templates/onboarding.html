<!-- onboarding.html -->
<!DOCTYPE html>
<html class="ob-html">
<head>
    <title>Onboarding | Sparky</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

</head>
<body class="ob-body">

    <div class="onboarding-nav">
        <button class="onboard-nav-button" id="onboard-nav-button"><i data-feather="chevron-left"></i></button>
        <button class="onboard-nav-button" id="closeButton"><i data-feather="x"></i></button>
    </div>

    <!-- Onboarding Modal -->
    <div id="onboardingModal" class="onboarding-modal">

        <!-- Navigation Bar -->
        <!-- <div class="onboarding-nav">
            <button onclick="goToPreviousStep()" class="onboard-nav-button" id="onboard-nav-button">
                <i data-feather="chevron-left"></i>
            </button>
            <button onclick="closeOnboarding()" class="onboard-nav-button" id="closeButton">
                <i data-feather="x"></i>
            </button>
        </div> -->


         <!-- Welcome Step (Taken from old welcome.html) -->
        <div class="modal-step" id="step1">
            <div class="container-onboarding">
                <div class="onboarding-body">
                    <h1>Welcome to Sparky.</h1>
                    <p>Connect your analytics and set your goals. We'll analyze your data to provide insights and strategies tailored towards you care about. We currently support Google Analytics 4 with more integrations coming soon.</p>
                </div>
                <div class="onboarding-CTA-container">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                            <div class="alert {{ category }}">{{ message }}</div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}             
                    <button onclick="nextStep(2)" data-next-step="2">Get Started</button>
                    <!-- <p class="disclaimer">We currently support Google Analytics 4, <br>with more integrations coming soon.</p> -->
                </div>
            </div>
        </div>

        <!-- Business Info Step (Taken from old business_info.html) -->
        <div class="modal-step" id="step2" style="display:none;">
            <div class="container-onboarding">
                <div class="onboarding-biz-body">
                  
                    
                    <form id="business-info-form" enctype="multipart/form-data">
                        <div class="biz-info-wrapper"></div>
                            <h1>Your business.</h1>
                            <p class="biz-body-copy">Tell us about your business so we can tailor Sparky's insights to your needs.</p>
                            <!-- Avatar Upload -->
                            <div class="form-group avatar-upload-container">
                                <p>Photo</p>
                                <div class="avatar-upload-wrapper">
                                    <div class="avatar-preview" id="avatar-placeholder"></div>
                                    <button type="button" id="avatar-button" onclick="handleAvatarClick()">Upload</button>
                                    <input type="file" id="avatar-upload" name="avatar" class="hidden" onchange="previewAvatar(event)">
                                </div>
                                
                            </div>

                            <!-- Business Name Input -->
                            <div class="form-group">
                                <p for="business-name">Name</p>
                                <input type="text" id="business-name" name="business_name" placeholder="Enter your business name">
                            </div>

                            <!-- Business Description Input -->
                            <div class="form-group">
                                <p for="business-description">Description</p>
                                <textarea id="business-description" name="business_description" placeholder="Describe your business"></textarea>
                            </div>
                        </div>

                        <div class="onboarding-CTA-container">
                            <button type="button" id="business-info-next">Next</button>
                        </div>
                    </form>
                </div>
            </div>
        
        

        <!-- Goals Step -->
        <div class="modal-step" id="step3" style="display:none;">
            <div class="container-onboarding">
                <div class="onboarding-biz-body">
                    <div class="biz-info-wrapper">
                        <h1>Set your goals.</h1>
                        <p>Prioritize your business goals, ranking from most to least important. This lets Sparky deliver more relevant and customized reports.</p>
                        <ul id="goalsList" class="draggable-list">
                            <li class="draggable-item" draggable="true"><span class="item-number">1</span> More visitors <i class="icon-right"></i></li>
                            <li class="draggable-item" draggable="true"><span class="item-number">2</span> Higher sales <i class="icon-right"></i></li>
                            <li class="draggable-item" draggable="true"><span class="item-number">3</span> Increase engagement <i class="icon-right"></i></li>
                            <li class="draggable-item" draggable="true"><span class="item-number">4</span> Improve conversion rate <i class="icon-right"></i></li>
                            <li class="draggable-item" draggable="true"><span class="item-number">5</span> Improve SEO rankings <i class="icon-right"></i></li>
                        </ul>
                    </div>
                    <div class="onboarding-CTA-container">
                        <button onclick="nextStep(4)">Next</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preferences Step -->
        <div class="modal-step" id="step4" style="display:none;">
            <div class="container-onboarding">
                <div class="onboarding-biz-body">
                    <div class="biz-info-wrapper">
                        <h1>Set your preferences.</h1>
                        <p>Rank the metrics you care about, we’ll keep you informed about data points that matter to you the most.</p>
                        <ul id="preferencesList" class="draggable-list">
                            <li class="draggable-item" draggable="true"><span class="item-number">1</span> Traffic sources <i class="icon-right"></i></li>
                            <li class="draggable-item" draggable="true"><span class="item-number">2</span> Top selling products <i class="icon-right"></i></li>
                            <li class="draggable-item" draggable="true"><span class="item-number">3</span> Customer value <i class="icon-right"></i></li>
                            <li class="draggable-item" draggable="true"><span class="item-number">4</span> Card abandonment <i class="icon-right"></i></li>
                            <li class="draggable-item" draggable="true"><span class="item-number">5</span> Bounce rate <i class="icon-right"></i></li>
                        </ul>
                    </div>
                    <div class="onboarding-CTA-container">
                        <button id="preferences-next">Next</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Step -->
        <div class="modal-step" id="step5" style="display:none;">
            <div class="container-onboarding">
            <div class="onboarding-biz-body">
                <div class="biz-info-wrapper">
                <h1>Your notifications.</h1>
                <p>Choose how you’d like to stay updated with your latest reports emailed from Sparky.</p>
                <div class="notif-options-container">
                    <div class="notification-option">
                        <span>Daily</span>
                        <label class="switch">
                        <input type="checkbox" id="report-daily" name="report_frequency" value="Daily">
                        <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="notification-option">
                        <span>Weekly</span>
                        <label class="switch">
                        <input type="checkbox" id="report-weekly" name="report_frequency" value="Weekly">
                        <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="notification-option">
                        <span>Monthly</span>
                        <label class="switch">
                        <input type="checkbox" id="report-monthly" name="report_frequency" value="Monthly">
                        <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                </div>
                <div class="edit-CTA-container">
                    <button id="notifications-next">Next</button>
                </div>
            </div>
            </div>
        </div>
        

    

        <!-- Confirmation Step -->
        <div class="modal-step" id="step6" style="display:none;">
            <div class="container-onboarding">
                <div class="onboarding-biz-body">
                    <div class="biz-info-wrapper">
                        <h1>You’re ready for your first report!</h1>
                        <p>You’ve successfully set up your profile, goals, and preferences. You may update these settings any time in the app.</p>
                    </div>
                    <div class="onboarding-CTA-container">
                        <a href="{{ url_for('main.select_property') }}"><button onclick="completeOnboarding()">Get Started</button></a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace(); // Initialize icons
        
            // Initialize sortable lists
            new Sortable(document.getElementById('goalsList'), {
                animation: 150,
                ghostClass: "sortable-ghost",
                onEnd: function(evt) {
                    updateNumbers('goalsList');
                }
            });
        
            new Sortable(document.getElementById('preferencesList'), {
                animation: 150,
                ghostClass: "sortable-ghost",
                onEnd: function(evt) {
                    updateNumbers('preferencesList');
                }
            });
        
            function updateNumbers(listId) {
                const list = document.getElementById(listId);
                Array.from(list.children).forEach((item, index) => {
                    item.querySelector('.item-number').textContent = index + 1;
                });
            }
        
            let currentStep = 1;
            let onboardingData = {};

            // document.getElementById('onboard-nav-button').addEventListener('click', goToPreviousStep);
            // document.getElementById('closeButton').addEventListener('click', closeOnboarding);
            // document.getElementById('avatar-button').addEventListener('click', handleAvatarClick);
            // // Assuming you have buttons with specific IDs for each next step in your HTML
            // document.querySelectorAll('[data-next-step]').forEach(button => {
            //     button.addEventListener('click', function() {
            //         const stepTo = parseInt(this.getAttribute('data-next-step'));
            //         nextStep(stepTo);
            //     });
            // });
            // document.getElementById('business-info-next').addEventListener('click', saveBusinessInfo);
            // document.getElementById('preferences-next').addEventListener('click', saveGoalsAndPreferences);
            // document.getElementById('notifications-next').addEventListener('click', saveNotificationSettings);


        
            function goToPreviousStep() {
                if (currentStep > 1) {
                    currentStep--;
                    showStep(currentStep);
                }
            }

            function nextStep(stepNumber) {
                if (stepNumber) {
                    showStep(stepNumber);
                }
            }

            function showStep(stepNumber) {
                document.querySelectorAll('.modal-step').forEach(step => step.style.display = 'none');
                document.getElementById(`step${stepNumber}`).style.display = 'block';
                currentStep = stepNumber;
            }

            document.getElementById('business-info-next').addEventListener('click', function() {
                onboardingData.businessName = document.getElementById('business-name').value;
                onboardingData.businessDescription = document.getElementById('business-description').value;
                // Save business info to the server before proceeding
                saveBusinessInfo(() => nextStep(3));
            });

            document.getElementById('preferences-next').addEventListener('click', function() {
                saveGoalsAndPreferences();
            });

            document.getElementById('notifications-next').addEventListener('click', function() {
                saveNotificationSettings();
            });


            function closeOnboarding() {
                fetch('/abandon_onboarding', { method: 'GET' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            window.location.href = "{{ url_for('auth.logout') }}";
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }


        
            document.querySelectorAll('.onboarding-CTA-container button').forEach(button => {
                button.addEventListener('click', function() {
                    const stepTo = parseInt(this.getAttribute('data-next-step'));
                    nextStep(stepTo);
                });
            });
        
     
                    
            function saveBusinessInfo(callback) {
                // Now includes avatar in the data sent to the server
                fetch('/save_business_info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        businessName: onboardingData.businessName,
                        businessDescription: onboardingData.businessDescription,
                        avatar: onboardingData.avatar, // Now includes avatar
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log('Business info saved successfully.');
                        if(callback) callback();
                    } else {
                        console.error('Failed to save business info.');
                    }
                })
                .catch(error => console.error('Error saving business info:', error));
            }


            function uploadAvatar(callback) {
                const avatarInput = document.getElementById('avatar-upload');
                if (avatarInput.files.length > 0) {
                    const formData = new FormData();
                    formData.append('avatar', avatarInput.files[0]);

                    fetch('/upload_avatar', {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            console.log('Avatar uploaded successfully:', data.avatarURL);
                            onboardingData.avatar = data.avatarURL; // Save avatar URL to onboardingData
                            if(callback) callback();
                        } else {
                            console.error('Failed to upload avatar.');
                        }
                    })
                    .catch(error => console.error('Error uploading avatar:', error));
                } else if(callback) {
                    callback(); // Proceed without avatar if not selected
                }
            }

        
            function saveGoalsAndPreferences() {
                onboardingData.goals = [...document.getElementById('goalsList').querySelectorAll('.draggable-item')].map((item, index) => item.textContent.trim());
                onboardingData.preferences = [...document.getElementById('preferencesList').querySelectorAll('.draggable-item')].map((item, index) => item.textContent.trim());
                nextStep(5); // Proceed to next step after saving
            }
        
            function saveNotificationSettings() {
                onboardingData.reportFrequency = [];
                if (document.getElementById('report-daily').checked) onboardingData.reportFrequency.push('Daily');
                if (document.getElementById('report-weekly').checked) onboardingData.reportFrequency.push('Weekly');
                if (document.getElementById('report-monthly').checked) onboardingData.reportFrequency.push('Monthly');
                nextStep(6); // Proceed to the final step
            }
        
            function completeOnboarding() {
                fetch('/complete_onboarding', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(onboardingData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Redirect or inform the user of successful onboarding
                        alert('Onboarding completed successfully!');
                        window.location.href = "{{ url_for('main.select_property') }}"; // Adjust this to your dashboard or relevant page
                    } else {
                        alert('Failed to complete onboarding. Please try again.');
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            }
        
            // function uploadAvatar() {
            //     const avatarInput = document.getElementById('avatar-upload');
            //     if (avatarInput.files.length > 0) {
            //         const fileReader = new FileReader();
            //         fileReader.onloadend = function(e) {
            //             onboardingData.avatar = e.target.result; // Assuming you want to save the Base64 representation
            //             document.getElementById('avatar-placeholder').style.backgroundImage = `url(${e.target.result})`;
            //             // Optionally send the avatar to the server here
            //         };
            //         fileReader.readAsDataURL(avatarInput.files[0]);
            //     }
            // }
        
            // Initiate avatar upload and preview on file selection
            document.getElementById('avatar-upload').addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    // Create FormData and append the file
                    let formData = new FormData();
                    formData.append('avatar', file);

                    // POST the file to the backend
                    fetch('/upload_avatar', {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => response.json())
                    .then(data => {
                        if(data.status === 'success') {
                            // Update onboardingData with the avatar URL
                            onboardingData.avatar = data.avatarURL;
                            // Update the avatar preview
                            document.getElementById('avatar-placeholder').style.backgroundImage = `url(${data.avatarURL})`;
                        } else {
                            console.error('Failed to upload avatar');
                        }
                    })
                    .catch(error => console.error('Error uploading avatar:', error));
                }
            });

            // Toggle avatar upload/remove button text
            function handleAvatarClick() {
                document.getElementById('avatar-upload').click();
            }

            document.getElementById('avatar-upload').addEventListener('change', function(event) {
                previewAvatar(event);
            });

            function previewAvatar(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('avatar-placeholder').style.backgroundImage = `url(${e.target.result})`;
                        // Here, you could also upload the avatar to Firebase as needed
                    };
                    reader.readAsDataURL(file);
                }
            }

        
            function removeAvatar() {
                document.getElementById('avatar-upload').value = '';
                document.getElementById('avatar-placeholder').style.backgroundImage = '';
                onboardingData.avatar = ''; // Clear avatar data
            }
        
            // Initialize the first step display
            showStep(currentStep);
        });
        </script>
        
</body>
</html>